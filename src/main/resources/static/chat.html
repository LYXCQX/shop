<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8" name="viewport"
	content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>钱牛牛</title>
<meta name="viewport" content="initial-scale=1, maximum-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<script type='text/javascript' src='shopMain/js/jquery.min.js'
	charset='utf-8'></script>
<style type="text/css">
* {
	margin: 0;
	padding: 0;
}

html, body {
	width: 100%;
	height: 100%;
}
</style>
</head>
<body
	style="background: url('shopMain/images/bjt1.png') no-repeat;background-size:cover;height: 100%;width: 100%;">
	<div>
		<input id="username"></input>
		<div id="ltk" class="message-container"
			style="width:25rem;height:30rem;overflow: scroll; line-hight:0.7rem;">
			<br />
		</div>
	</div>
	<div align="center" style="padding:20px 0;position:absolute; bottom:0; width:100%;">
		<input id="msg" style="padding:0 1.3rem;border:none; border-radius: 2em;background: #fff;
		color: #535d92;font-weight: bold;
    font-family: Helvetica Neue, Helvetica, Arial, sans-serif;line-height: normal;width:60%; height:2.6rem"/>
		<button onclick="sendMsgToServer()" style="border:none;width:25%; height:2.6rem;background:#39A4FF; line-height:normal; border-radius: 1em;color:white;">发送 (enter)</button>
	</div>
	<script>
		/**
		 * WebSocket客户端
		 *
		 * 使用说明：
		 * 1、WebSocket客户端通过回调函数来接收服务端消息。例如：webSocket.onmessage
		 * 2、WebSocket客户端通过send方法来发送消息给服务端。例如：webSocket.send();
		 */
		function getWebSocket() {
			/**
			 * WebSocket客户端 PS：URL开头表示WebSocket协议 中间是域名端口 结尾是服务端映射地址
			 */
			var webSocket = new WebSocket( /*[[${webSocketUrl}]]*/ 'ws://139.196.88.68:6837/qnn/notify');
			/**
			 * 当服务端打开连接
			 */
			webSocket.onopen = function(event) {
				console.log('WebSocket打开连接');
			};
	
			/**
			 * 当服务端发来消息：1.广播消息 2.更新在线人数
			 */
			webSocket.onmessage = function(event) {
				console.log('WebSocket收到消息：%c' + event.data, 'color:green');
				//获取服务端消息
				var message = JSON.parse(event.data) || {};
				var $messageContainer = $('.message-container');
				//喉咙发炎
				if (message.type === 'SPEAK') {
					if (message.userName == $("#username").val()) {
						$messageContainer.append('<div class="mesage" style="margin-right:1rem; float:right;background:#39A4FF;max-width:50%; border-radius:5px; padding:0.3rem 1rem; text-align:right;color:white;">' + message.userName + ': ' + message.msg + '</div><br/><br/>');
					} else {
						$messageContainer.append('<div class="mesage" style="margin-left:1rem; float:left;background:#39A4FF;max-width:50%; border-radius:5px; padding:0.3rem 1rem;text-align:left;">' + message.userName + ': ' + message.msg + '</div><br/><br/>');
					}
					/* 	 document.querySelector("#ltk").scrollIntoView(false); */
					var highta = 0;
					$(".mesage").each(function(i, element) {
						highta += $(this).height() + 3;
					})
					$("#ltk").scrollTop(highta);
				}
			/* //防止刷屏
			var $cards = $messageContainer.children('.mdui-card:visible').toArray();
			if ($cards.length > 5) {
				$cards.forEach(function(item, index) {
					index < $cards.length - 5 && $(item).slideUp('fast');
				});
			} */
			};
	
			/**
			 * 关闭连接
			 */
			webSocket.onclose = function(event) {
				console.log('WebSocket关闭连接');
			};
	
			/**
			 * 通信失败
			 */
			webSocket.onerror = function(event) {
				console.log('WebSocket发生异常');
	
			};
			return webSocket;
		}
	
		var webSocket = getWebSocket();
	
	
		/**
		 * 通过WebSocket对象发送消息给服务端
		 */
		function sendMsgToServer() {
			var $message = $('#msg');
			if ($message.val()) {
				webSocket.send(JSON.stringify({
					userName : $("#username").val(),
					type : "SPEAK",
					msg : $message.val(),
					pid : $('#pid').val()
				}));
			}
	
		}
	
		/**
		 * 使用ENTER发送消息
		 */
		document.onkeydown = function(event) {
			var e = event || window.event || arguments.callee.caller.arguments[0];
			e.keyCode === 13 && sendMsgToServer();
		};
		$("#ltk").width(document.body.clientWidth);
		$("#ltk").height(document.body.clientHeight*0.85);
	</script>
</body>
</html>